class ExploitScene extends WinBase{

	private imgExploitType: eui.Image;
	private lTotalExploit: eui.Label;
	private lSKGExploit: eui.Label;
	private rectTotalExploit: eui.Rect;
	private rectSKGExploit: eui.Rect;
	private gTotalExploit: eui.Group;
	private lGameNum: eui.Label;
	private lWinRate: eui.Label;
	private lEscapeNum: eui.Label;
	private lNote: eui.Label;
	private scroller1: eui.Scroller;
	private exploitList1: eui.List;
	private gSKGExploit: eui.Group;
	// private lSKGTotalPoint: eui.Label;
	private lSKGTotalRounds: eui.Label;
	private scroller2: eui.Scroller;
	private exploitList2: eui.List;


	private gameTypeId:number = 0;//从0开始

	public constructor() {
		super();
		this.addEventListener(eui.UIEvent.COMPLETE,this.onComplete,this);
     	this.skinName = "resource/wnd/ExploitWnd.exml";
	}

	private onComplete():void{
		this.init();
    }

	private init():void
	{
		this.initListener();
		// if(WndManager.root.main.protocol.jumpGametypeId >0)
		// {
		// 	this.gameTypeId = WndManager.root.main.protocol.jumpGametypeId;
		// 	this.handleSKGExploitClick(null);
		// }
		// else
		// {
			this.handleTotalExploitClick(null);
		//}
	}

	private initListener():void
	{
		this.addEventListener("openSKGExploit",this.openSKGExploit,this);
		this.addEventListener("openSRExploit",this.openSRExploit,this);
		this.rectTotalExploit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.handleTotalExploitClick,this);
		this.rectSKGExploit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.handleSKGExploitClick,this);
	}

	//切换对应游戏战绩界面
	private openSKGExploit(e:egret.Event):void
	{
		this.gameTypeId = Number(e.data);
		this.handleSKGExploitClick(null);
	}

	//打开单局战绩界面
	private openSRExploit(e:egret.Event):void
	{
		var roomId:number = Number(e.data);
		var grd:GameRoundData = WndManager.root.main.dataManager.MyExploit.getRoundDataByGameTypeAndRoomId(this.gameTypeId,roomId);

		if(null != grd)
		{
			var res:RoundExploitScene = new RoundExploitScene(grd);
			this.addChild(res);
		}
	}

	//打开单局战绩界面,显示对应战绩
	private openFristSRExploit():void
	{
		var grd:GameRoundData = WndManager.root.main.dataManager.MyExploit.getNo1RoundDataByGameType(this.gameTypeId);

		if(null != grd)
		{
			var res:RoundExploitScene = new RoundExploitScene(grd);
			this.addChild(res);
		}
	}

	//总战绩
	private handleTotalExploitClick(e:egret.TouchEvent):void
	{
		this.imgExploitType.x = 35;
		this.lTotalExploit.textColor = 0xffffff;
		this.lSKGExploit.textColor = 0x68D9C3;		
		this.gTotalExploit.visible = true;
		this.gSKGExploit.visible = false;
		this.initData();
	}

	//单个游戏战绩
	private handleSKGExploitClick(e:egret.TouchEvent):void
	{
		this.imgExploitType.x = 321;
		this.lTotalExploit.textColor = 0x68D9C3;
		this.lSKGExploit.textColor = 0xffffff;	
		this.gTotalExploit.visible = false;
		this.gSKGExploit.visible = true;
		this.initData();
	}

	protected release():void
	{
		this.removeEventListener("openSKGExploit",this.openSKGExploit,this);
		this.removeEventListener("openSRExploit",this.openSRExploit,this);
		this.rectTotalExploit.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.handleTotalExploitClick,this);
		this.rectSKGExploit.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.handleSKGExploitClick,this);
	}
 
	private initData():void
	{
		//总战绩，所有游戏
		if(this.imgExploitType.x == 35)
		{
			this.initTotalExploitData();
		}
		else
		{
			this.initSRExploitData();
		}
	}

	//总战绩，所有游戏
	private initTotalExploitData():void
	{
		this.lGameNum.text = WndManager.root.main.dataManager.MyExploit.TotalRounds.toString();

		this.lWinRate.text = WndManager.root.main.dataManager.MyExploit.WinRate.toString();
		this.lEscapeNum.text = WndManager.root.main.dataManager.MyExploit.TotalEscape.toString();

		this.scroller1.scrollPolicyH = eui.ScrollPolicy.OFF;

		this.exploitList1.dataProvider = new eui.ArrayCollection(WndManager.root.main.dataManager.MyExploit.GameRecordArrJsonString);
		this.exploitList1.itemRenderer = SKGExploitItemRender;

		this.scroller1.viewport = this.exploitList1;

		//计算默认游戏id
		this.gameTypeId=WndManager.root.main.dataManager.MyExploit.getDefaultGameId();


		if(WndManager.root.main.dataManager.MyExploit.GameRecordArrJsonString.length>=6)
		{
			this.lNote.y = 200+6*100;
			this.scroller1.height = 6*100;
		}
		else
		{
			this.lNote.y = 200+WndManager.root.main.dataManager.MyExploit.GameRecordArrJsonString.length * 100;
		}

		if(WndManager.root.main.protocol.jumpGametypeId >0)
		{
			this.gameTypeId = WndManager.root.main.protocol.jumpGametypeId;
			this.handleSKGExploitClick(null);
		}
	}

	//某一类游戏 7天战绩
	private initSRExploitData():void
	{
		console.log("gametype="+this.gameTypeId);

		WndManager.root.main.protocol.addEventListener("OngetMyExploit",this.ongetMyExploit,this);
		WndManager.root.main.protocol.getMyExploit(this.gameTypeId);


		//if(this.gameTypeId>=0 && this.gameTypeId < WndManager.root.main.dataManager.MyExploit.GameRecordArr.length)
		{
			var gr:GameRecord = WndManager.root.main.dataManager.MyExploit.getGameRecordByGameType(this.gameTypeId);
			// this.lSKGTotalPoint.text = gr.TotalPoint.toString();
			this.lSKGTotalRounds.text = gr.TotalRound.toString();

			this.scroller2.scrollPolicyH = eui.ScrollPolicy.OFF;
			
			this.exploitList2.itemRenderer = SRExploitItemRender;

			this.scroller2.viewport = this.exploitList2;

		}
	}

	private ongetMyExploit(e:egret.Event):void
	{
		this.exploitList2.dataProvider = new eui.ArrayCollection(WndManager.root.main.dataManager.MyExploit.getRoundDataArrByGameType(this.gameTypeId));

		if(WndManager.root.main.protocol.jumpGametypeId >0)
		{
			WndManager.root.main.protocol.jumpGametypeId =0;
			WndManager.root.main.protocol.jumpRoomKey = "";
			this.openFristSRExploit();
		}
	}

}